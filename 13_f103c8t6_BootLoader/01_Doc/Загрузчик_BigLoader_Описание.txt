8 февраля 2023 года (Вт)

Сокращения:
З    - загрузчик
МК   - микроконтроллер
ОХСП - обасть хранения состояния приложения
//*************************************************************
Параметры З:
Интерфейс        : I2C (I2C1 или I2C зависит от устройства)
Скорость         : 400кГц (возможно лучше 100кГц для лучшей надежности)
Переход в режим З: при старте МК первым запускается З
Начальный адрес  : 0х0800 0000
Размер	         : 10КБ(10240 байт = 0х2800)
из них 9КБ - это сам З,
       1КБ - это ОХСП.

Праметры приложения: 
Начальный адрес: 0х0800 0000 + 0х2800 = 0х0800 2800
Размер         : размер_флеш_памяти_МК - размер_загрузчика
Условие перехода из З в приложение: таймаут (1 сек.)
                                    по команде (команда Go загрузчика) 

//************Порядок прошивки микроконтроллера****************
1) Очистить ВСЮ флеш-память МК с помошь программатора и утилиты ST-Link (команда Erase Chip)
2) Прошить загрузчик с помошь программатора и утилиты ST-Link
3) Прошить приложение с помошь программатора и утилиты ST-Link 
  После этих манипуляций и после ресета МК, первым запустится загрузчик, он увидит что есть основное 
приложение и передаст управление ему. Так же будет доступна прошивка внутренней флеш-памяти МК через загрузчик. 
  Так же можно пропустить шаг №3 при прошивке МК. В этом случае после ресета МК первым запустится загрузчик, 
он увидит что основного приложения нет и будет ожидать прихода команд. 
  Подробное описание команд смотреть в файле AN4221_I2C protocol used in the STM32 bootloader_Перевод.pdf

//************ОХСП - обасть хранения состояния приложения******
  Эта область нужна для передачи информации из приложения в З. 
Например, есть устройство, в котором есть МК с нашим З. Через некоторое время эксплуатации появилась наобходимость удаленно обновить прошивку 
этого устройства. Для этого мы посылаем устройству по его протоколу обмена команду перезапуска, а в ОХСП устанавливаем признак обновления прошивки.
После перезапуска МК запускается З и ждет новой прошивки по I2C.

Состояния приложения
APP_NO			0xFFFFFFFF	//приложение отсутствует 
APP_OK_AND_START 	0xAAAA0001	//CRC в норме, можно запускать
APP_REWRITE_ME		0xAAAA0002	//была команда на переход в загрузчик после ресета
.
.
.
.
APP_CRC_ERR 		0xAAAA001F	//ошибка CRC	



0b0111000






