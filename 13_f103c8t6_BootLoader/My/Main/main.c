/*
 * 	main.c
 *
 *  Created on: 19 октября 2021 года.
 *  Autho     : Беляев А.А.
 *
 *	Описание        : I2C Boot Loader
 *  Датчики         :
 *  Вывод информации:
 *
 */
//*******************************************************************************************
//*******************************************************************************************

#include "main.h"

//*******************************************************************************************
//*******************************************************************************************


//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************

//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
int main(void){

	__disable_irq();
	STM32_Clock_Init();
	GPIO_Init();
	DELAY_Init();
	//***********************************************
	//Мигнем три раза - индикация запуска загрузчика.
	for(uint32_t i = 0; i < 3; i++)
	{
		DELAY_milliS(50);
		LED_PC13_On();
		DELAY_milliS(50);
		LED_PC13_Off();
	}
	//***********************************************
	BOOTLOADER_Init(); //Инициализация I2C Slave для работы по прерываниям.
	__enable_irq();
	//***********************************************
	uint32_t micros = DELAY_microSecCount();
	//По истечени таймаута переходим в приложение.
	while(BOOTLOADER_GetStateI2C() != I2C_IT_STATE_ADDR_WR &&	//нет запросов от хоста по I2C
		  BOOTLOADER_GetAppState() == APP_OK_AND_START)		 	//есть признак запуска приложения
	{
		//Отсчет таймаута
		if((DELAY_microSecCount() - micros) >= (BOOT_I2C_TIMEOUT_MS*1000))
		{
			//Переход на приложение
			BOOTLOADER_GoToApp(APP_PROGRAM_START_ADDR);
		}
	}
	//***********************************************
	while(1)
	{
		BOOTLOADER_Loop(); //Загрузчик
	}
}
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//Прерывание каждую милисекунду.
void SysTick_IT_Handler(void){

}
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************






