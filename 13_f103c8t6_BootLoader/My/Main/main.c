/*
 * 	main.c
 *
 *  Created on: 19 октября 2021 года.
 *  Autho     : Беляев А.А.
 *
 *	Описание        :
 *  Датчики         :
 *  Вывод информации:
 *
 */
//*******************************************************************************************
//*******************************************************************************************

#include "main.h"

//*******************************************************************************************
//*******************************************************************************************
#define APP_START_ADDR	(FLASH_BASE + 6 * 1024)	//Адрес приложения

//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
static void _initAll(void){

	STM32_Clock_Init();
	GPIO_Init();
	DELAY_Init();
//	SYS_TICK_Init();
//	I2C_Master_Init(I2C1, I2C_GPIO_NOREMAP, 400000);
}
//************************************************************

//************************************************************

//************************************************************
static void _goToApp(uint32_t appAddr){

	void(*goToApp)(void);
	//------------------
	appAddr = *(volatile uint32_t*)(appAddr + 4);
	goToApp = (void(*)(void))appAddr;

	__disable_irq();						 //
	__set_MSP(*(volatile uint32_t*)appAddr); //
	goToApp();								 //переход на приложение.
}
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
int main(void){

//	__disable_irq();
//	SCB->VTOR = 0x08002800;
	//***********************************************
	_initAll(); //Инициализация нужной периферии.

	DELAY_milliS(1000);//Задержка для стабилизации напряжения питания.
	//***********************************************
	//Мигнем три раза - индикация запуска загрузчика.
	for(uint32_t i = 0; i < 3; i++)
	{
		LED_PC13_On();
		DELAY_milliS(250);
		LED_PC13_Off();
		DELAY_milliS(250);
	}

	_goToApp(APP_START_ADDR);

//	SYS_TICK_Control(SYS_TICK_ON);
//	__enable_irq();

	DELAY_milliS(1000);
	//**************************************************************
	while(1)
	{
		LED_PC13_Toggel();
		DELAY_milliS(50);
		//__WFI();//Sleep
	}
	//**************************************************************
}
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//Прерывание каждую милисекунду.
void SysTick_IT_Handler(void){

}
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************
//*******************************************************************************************






